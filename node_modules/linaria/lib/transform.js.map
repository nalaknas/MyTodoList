{"version":3,"sources":["../src/transform.ts"],"names":["STYLIS_DECLARATION","posixSep","path","posix","sep","babelPreset","require","resolve","transformUrl","url","outputFilename","sourceFilename","platformPath","relative","dirname","split","join","transform","code","options","test","sourceMap","inputSourceMap","filename","pluginOptions","babelOptions","ast","caller","name","metadata","transformedCode","map","rootMode","presets","babelrc","configFile","sourceMaps","sourceFileName","linaria","rules","replacements","dependencies","mappings","cssText","preprocessor","selector","text","stylis","use","context","decl","replace","match","p1","p2","p3","p4","Object","keys","forEach","index","push","generated","line","column","original","start","source","version","toString","cssSourceMapText","length","generator","SourceMapGenerator","file","mapping","addMapping","assign","setSourceContent"],"mappings":"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","sourcesContent":["/**\n * This file exposes transform function that:\n * - parse the passed code to AST\n * - transforms the AST using Linaria babel preset ('./babel/index.js) and additional config defined in Linaria config file or passed to bundler configuration.\n * - runs generated CSS files through default of user-defined preprocessor\n * - generates source maps for CSS files\n * - return transformed code (without Linaria template literals), generated CSS, source maps and babel metadata from transform step.\n */\n\nimport path from 'path';\nimport { parseSync, transformFromAstSync } from '@babel/core';\nimport stylis from 'stylis';\nimport type { Mapping } from 'source-map';\nimport { SourceMapGenerator } from 'source-map';\nimport loadOptions from './babel/utils/loadOptions';\nimport { debug } from './babel/utils/logger';\nimport type { LinariaMetadata, Options, PreprocessorFn, Result } from './types';\n\nconst STYLIS_DECLARATION = 1;\nconst posixSep = path.posix.sep;\nconst babelPreset = require.resolve('./babel');\n\nexport function transformUrl(\n  url: string,\n  outputFilename: string,\n  sourceFilename: string,\n  platformPath: typeof path = path\n) {\n  // Replace asset path with new path relative to the output CSS\n  const relative = platformPath.relative(\n    platformPath.dirname(outputFilename),\n    // Get the absolute path to the asset from the path relative to the JS file\n    platformPath.resolve(platformPath.dirname(sourceFilename), url)\n  );\n\n  if (platformPath.sep === posixSep) {\n    return relative;\n  }\n\n  return relative.split(platformPath.sep).join(posixSep);\n}\n\nexport default function transform(code: string, options: Options): Result {\n  // Check if the file contains `css` or `styled` words first\n  // Otherwise we should skip transforming\n  if (!/\\b(styled|css)/.test(code)) {\n    return {\n      code,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  debug(\n    'transform',\n    `${options.filename} to ${options.outputFilename}\\n${code}`\n  );\n\n  const pluginOptions = loadOptions(options.pluginOptions);\n  const babelOptions = pluginOptions?.babelOptions ?? null;\n\n  // Parse the code first so babel uses user's babel config for parsing\n  // We don't want to use user's config when transforming the code\n  const ast = parseSync(code, {\n    ...babelOptions,\n    filename: options.filename,\n    caller: { name: 'linaria' },\n  });\n\n  const { metadata, code: transformedCode, map } = transformFromAstSync(\n    ast!,\n    code,\n    {\n      ...(babelOptions?.rootMode ? { rootMode: babelOptions.rootMode } : null),\n      filename: options.filename,\n      presets: [[babelPreset, pluginOptions]],\n      babelrc: false,\n      configFile: false,\n      sourceMaps: true,\n      sourceFileName: options.filename,\n      inputSourceMap: options.inputSourceMap,\n    }\n  )!;\n\n  if (\n    !metadata ||\n    !(metadata as babel.BabelFileMetadata & { linaria: LinariaMetadata })\n      .linaria\n  ) {\n    return {\n      code,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  const {\n    rules,\n    replacements,\n    dependencies,\n  } = (metadata as babel.BabelFileMetadata & {\n    linaria: LinariaMetadata;\n  }).linaria;\n  const mappings: Mapping[] = [];\n\n  let cssText = '';\n\n  let preprocessor: PreprocessorFn;\n  if (typeof options.preprocessor === 'function') {\n    // eslint-disable-next-line prefer-destructuring\n    preprocessor = options.preprocessor;\n  } else {\n    switch (options.preprocessor) {\n      case 'none':\n        preprocessor = (selector, text) => `${selector} {${text}}\\n`;\n        break;\n      case 'stylis':\n      default:\n        stylis.use(null)((context, decl) => {\n          const { outputFilename } = options;\n          if (context === STYLIS_DECLARATION && outputFilename) {\n            // When writing to a file, we need to adjust the relative paths inside url(..) expressions\n            // It'll allow css-loader to resolve an imported asset properly\n            return decl.replace(\n              /\\b(url\\(([\"']?))(\\.[^)]+?)(\\2\\))/g,\n              (match, p1, p2, p3, p4) =>\n                p1 + transformUrl(p3, outputFilename, options.filename) + p4\n            );\n          }\n\n          return decl;\n        });\n\n        preprocessor = stylis;\n    }\n  }\n\n  Object.keys(rules).forEach((selector, index) => {\n    mappings.push({\n      generated: {\n        line: index + 1,\n        column: 0,\n      },\n      original: rules[selector].start!,\n      name: selector,\n      source: '',\n    });\n\n    // Run each rule through stylis to support nesting\n    cssText += `${preprocessor(selector, rules[selector].cssText)}\\n`;\n  });\n\n  return {\n    code: transformedCode || '',\n    cssText,\n    rules,\n    replacements,\n    dependencies,\n    sourceMap: map\n      ? {\n          ...map,\n          version: map.version.toString(),\n        }\n      : null,\n\n    get cssSourceMapText() {\n      if (mappings?.length) {\n        const generator = new SourceMapGenerator({\n          file: options.filename.replace(/\\.js$/, '.css'),\n        });\n\n        mappings.forEach((mapping) =>\n          generator.addMapping(\n            Object.assign({}, mapping, { source: options.filename })\n          )\n        );\n\n        generator.setSourceContent(options.filename, code);\n\n        return generator.toString();\n      }\n\n      return '';\n    },\n  };\n}\n"],"file":"transform.js"}