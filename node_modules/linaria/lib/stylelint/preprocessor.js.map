{"version":3,"sources":["../../src/stylelint/preprocessor.ts"],"names":["preprocessor","errors","cache","code","input","filename","result","undefined","e","rules","replacements","cssText","Object","keys","forEach","selector","rule","line","split","length","start","displayName","last","pop","column","error","prefix","message","startsWith","replace","loc","find","l","includes","Number","trim","errored","warnings","push","name","text","severity","original","w","end","module","exports"],"mappings":"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","sourcesContent":["import stripAnsi from 'strip-ansi';\nimport transform from '../transform';\nimport type { Replacement } from '../types';\n\ntype Errors = {\n  [key: string]:\n    | {\n        name?: string;\n        code?: string;\n        message: string;\n        pos?: number;\n        loc?: {\n          line: number;\n          column: number;\n        };\n      }\n    | null\n    | undefined;\n};\n\ntype Cache = {\n  [key: string]: Replacement[] | null | undefined;\n};\n\ntype Warning = {\n  rule?: string;\n  text: string;\n  severity: 'error' | 'warning';\n  line: number;\n  column: number;\n};\n\ntype LintResult = {\n  errored: boolean;\n  warnings: Warning[];\n};\n\nfunction preprocessor() {\n  const errors: Errors = {};\n  const cache: Cache = {};\n\n  return {\n    code(input: string, filename: string) {\n      let result;\n\n      try {\n        result = transform(input, {\n          filename,\n        });\n\n        cache[filename] = undefined;\n        errors[filename] = undefined;\n      } catch (e) {\n        cache[filename] = undefined;\n        errors[filename] = e;\n\n        // Ignore parse errors here\n        // We handle it separately\n        return '';\n      }\n\n      const { rules, replacements } = result;\n\n      if (!rules) {\n        return '';\n      }\n\n      // Construct a CSS-ish file from the unprocessed style rules\n      let cssText = '';\n\n      Object.keys(rules).forEach((selector) => {\n        const rule = rules[selector];\n\n        // Append new lines until we get to the start line number\n        let line = cssText.split('\\n').length;\n\n        while (rule.start && line < rule.start.line) {\n          cssText += '\\n';\n          line++;\n        }\n\n        cssText += `.${rule.displayName} {`;\n\n        // Append blank spaces until we get to the start column number\n        const last = cssText.split('\\n').pop();\n\n        let column = last ? last.length : 0;\n\n        while (rule.start && column < rule.start.column) {\n          cssText += ' ';\n          column++;\n        }\n\n        cssText += `${rule.cssText} }`;\n      });\n\n      cache[filename] = replacements;\n\n      return cssText;\n    },\n    result(result: LintResult, filename: string) {\n      const error = errors[filename];\n      const replacements = cache[filename];\n\n      if (error) {\n        // Babel adds this to the error message\n        const prefix = `${filename}: `;\n\n        let message = stripAnsi(\n          error.message.startsWith(prefix)\n            ? error.message.replace(prefix, '')\n            : error.message\n        );\n\n        let { loc } = error;\n\n        if (!loc) {\n          // If the error doesn't have location info, try to find it from the code frame\n          const line = message.split('\\n').find((l) => l.startsWith('>'));\n          const column = message.split('\\n').find((l) => l.includes('^'));\n\n          if (line && column) {\n            loc = {\n              line: Number(line.replace(/^> /, '').split('|')[0].trim()),\n              column: column.replace(/[^|]+\\|\\s/, '').length,\n            };\n          }\n        }\n\n        if (loc) {\n          // Strip the codeframe text if we have location of the error\n          // It's formatted badly by stylelint, so not very helpful\n          message = message.replace(/^>?\\s+\\d?\\s\\|.*$/gm, '').trim();\n        }\n\n        // eslint-disable-next-line no-param-reassign\n        result.errored = true;\n        result.warnings.push({\n          rule: error.code || error.name,\n          text: message,\n          line: loc ? loc.line : 0,\n          column: loc ? loc.column : 0,\n          severity: 'error',\n        });\n      }\n\n      if (replacements) {\n        replacements.forEach(({ original, length }) => {\n          // If the warnings contain stuff that's been replaced,\n          // Correct the line and column numbers to what's replaced\n          result.warnings.forEach((w) => {\n            /* eslint-disable no-param-reassign */\n\n            if (w.line === original.start.line) {\n              // If the error is on the same line where an interpolation started, we need to adjust the line and column numbers\n              // Because a replacement would have increased or decreased the column numbers\n              // If it's in the same line where interpolation ended, it would have been adjusted during replacement\n              if (w.column > original.start.column + length) {\n                // The error is from an item after the replacements\n                // So we need to adjust the column\n                w.column +=\n                  original.end.column - original.start.column + 1 - length;\n              } else if (\n                w.column >= original.start.column &&\n                w.column < original.start.column + length\n              ) {\n                // The linter will underline the whole word in the editor if column is in inside a word\n                // Set the column to the end, so it will underline the word inside the interpolation\n                // e.g. in `${colors.primary}`, `primary` will be underlined\n                w.column =\n                  original.start.line === original.end.line\n                    ? original.end.column - 1\n                    : original.start.column;\n              }\n            }\n          });\n        });\n      }\n\n      return result;\n    },\n  };\n}\n\nmodule.exports = preprocessor;\n"],"file":"preprocessor.js"}